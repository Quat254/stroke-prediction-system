{% extends "base.html" %}

{% block title %}Admin Dashboard - Omeka{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="color: #d4af37; margin-bottom: 10px;">🛡️ Admin Control Panel</h1>
            <p style="color: #1e3a5f; font-size: 1.1rem;">System Administration Dashboard - {{ admin_name }}</p>
        </div>
        <a href="{{ url_for('admin_logout') }}" class="btn btn-secondary">
            🚪 Admin Logout
        </a>
    </div>
</div>

<div class="grid-4">
    <div class="card">
        <h2 style="color: #228B22;">👥 Total Users</h2>
        <div style="font-size: 3rem; font-weight: bold; color: #228B22; text-align: center;">
            {{ total_users }}
        </div>
        <p style="text-align: center; color: #666; margin-top: 10px;">Registered Patients</p>
    </div>
    
    <div class="card">
        <h2 style="color: #1e3a5f;">📊 Total Assessments</h2>
        <div style="font-size: 3rem; font-weight: bold; color: #1e3a5f; text-align: center;">
            {{ total_assessments }}
        </div>
        <p style="text-align: center; color: #666; margin-top: 10px;">Risk Evaluations</p>
    </div>
    
    <div class="card">
        <h2 style="color: #d4af37;">⚠️ High Risk Cases</h2>
        <div style="font-size: 3rem; font-weight: bold; color: #d4af37; text-align: center;">
            {{ high_risk_count }}
        </div>
        <p style="text-align: center; color: #666; margin-top: 10px;">Require Follow-up</p>
    </div>
    
    <div class="card">
        <h2 style="color: #dc3545;">🚨 Critical Cases</h2>
        <div style="font-size: 3rem; font-weight: bold; color: #dc3545; text-align: center;">
            {{ critical_count }}
        </div>
        <p style="text-align: center; color: #666; margin-top: 10px;">Immediate Attention</p>
    </div>
</div>

<div class="grid-2">
    <div class="card">
        <h2>🎯 User Management</h2>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <a href="{{ url_for('admin_users') }}" class="btn">
                👥 Manage User Accounts
            </a>
            <a href="{{ url_for('admin_user_activity') }}" class="btn btn-secondary">
                📈 User Activity Logs
            </a>
            <a href="{{ url_for('admin_deactivated_users') }}" class="btn btn-secondary">
                🚫 Deactivated Accounts
            </a>
        </div>
    </div>
    
    <div class="card">
        <h2>📊 Health Data Oversight</h2>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <a href="{{ url_for('admin_assessments') }}" class="btn">
                📋 Assessment Analytics
            </a>
            <a href="{{ url_for('admin_high_risk_cases') }}" class="btn" style="background: linear-gradient(45deg, #d4af37, #1e3a5f);">
                ⚠️ High-Risk Follow-ups
            </a>
            <a href="{{ url_for('admin_data_export') }}" class="btn btn-secondary">
                📤 Export Health Data
            </a>
        </div>
    </div>
</div>

<div class="grid-2">
    <div class="card">
        <h2>🔧 System Management</h2>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <a href="{{ url_for('admin_system_settings') }}" class="btn">
                ⚙️ System Configuration
            </a>
            <a href="{{ url_for('admin_templates') }}" class="btn btn-secondary">
                📝 Assessment Templates
            </a>
            <a href="{{ url_for('admin_announcements') }}" class="btn btn-secondary">
                📢 System Announcements
            </a>
            <a href="{{ url_for('admin_reports') }}" class="btn btn-secondary">
                📄 Report Management
            </a>
        </div>
    </div>
    
    <div class="card">
        <h2>🔒 Security & Communication</h2>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <a href="{{ url_for('admin_login_logs') }}" class="btn">
                🔍 Login Audit Trail
            </a>
            <a href="{{ url_for('admin_feedback') }}" class="btn">
                💬 User Feedback
            </a>
            <a href="{{ url_for('admin_system_logs') }}" class="btn btn-secondary">
                📋 System Activity Logs
            </a>
        </div>
    </div>
</div>

<div class="card">
    <h2>📈 Risk Level Distribution & Analytics</h2>
    {% if risk_distribution %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            {% for risk_level, count in risk_distribution %}
                <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid {% if risk_level in ['Very Low', 'Low'] %}#228B22{% elif risk_level == 'Moderate' %}#d4af37{% elif risk_level == 'High' %}#fd7e14{% else %}#dc3545{% endif %};">
                    <div style="font-size: 2rem; font-weight: bold; color: {% if risk_level in ['Very Low', 'Low'] %}#228B22{% elif risk_level == 'Moderate' %}#d4af37{% elif risk_level == 'High' %}#fd7e14{% else %}#dc3545{% endif %};">
                        {{ count }}
                    </div>
                    <div style="color: #666; font-weight: bold; margin-top: 5px;">
                        {% if risk_level == 'Very Low' %}🟢 Very Low Risk
                        {% elif risk_level == 'Low' %}🟢 Low Risk
                        {% elif risk_level == 'Moderate' %}🟡 Moderate Risk
                        {% elif risk_level == 'High' %}🟠 High Risk
                        {% elif risk_level == 'Very High' %}🔴 Very High Risk
                        {% elif risk_level == 'Critical' %}🚨 Critical Risk
                        {% else %}{{ risk_level }}{% endif %}
                    </div>
                    <div style="color: #999; font-size: 12px; margin-top: 5px;">
                        {{ "%.1f"|format((count / total_assessments * 100) if total_assessments > 0 else 0) }}% of total
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="color: #666; text-align: center; padding: 20px;">No assessment data available yet</p>
    {% endif %}
</div>

<div class="card">
    <h2>🚨 Recent High-Risk Cases Requiring Follow-up</h2>
    {% if high_risk_assessments %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; color: #228B22;">Patient</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; color: #228B22;">Age</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; color: #228B22;">Risk Level</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; color: #228B22;">Risk Score</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; color: #228B22;">Assessment Date</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; color: #228B22;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assessment in high_risk_assessments %}
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px; font-weight: bold; color: #1e3a5f;">{{ assessment[2] }}</td>
                            <td style="padding: 12px;">{{ assessment[3] }}</td>
                            <td style="padding: 12px;">
                                <span style="color: {% if assessment[4] == 'High' %}#d4af37{% elif assessment[4] == 'Very High' %}#dc3545{% else %}#dc3545{% endif %}; font-weight: bold;">
                                    {% if assessment[4] == 'High' %}🟠 High
                                    {% elif assessment[4] == 'Very High' %}🔴 Very High
                                    {% elif assessment[4] == 'Critical' %}🚨 Critical
                                    {% else %}{{ assessment[4] }}{% endif %}
                                </span>
                            </td>
                            <td style="padding: 12px;">
                                <span style="font-weight: bold; color: #dc3545;">{{ "%.1f"|format(assessment[5]) }}%</span>
                            </td>
                            <td style="padding: 12px;">{{ assessment[6][:10] if assessment[6] else 'N/A' }}</td>
                            <td style="padding: 12px;">
                                <button onclick="markFollowedUp({{ assessment[0] }})" class="btn" style="background: linear-gradient(45deg, #228B22, #1e3a5f); padding: 6px 12px; font-size: 12px;">
                                    ✅ Mark Followed Up
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="color: #666; text-align: center; padding: 20px;">No high-risk cases requiring immediate follow-up</p>
    {% endif %}
</div>

<div class="card">
    <h2>📊 System Health & Usage Trends</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #1e3a5f;">
            <h3 style="color: #1e3a5f; margin-bottom: 10px;">📈 Daily Activity</h3>
            <p style="font-size: 1.5rem; font-weight: bold; color: #1e3a5f;">{{ daily_assessments }}</p>
            <p style="color: #666; font-size: 14px;">Assessments today</p>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #228B22;">
            <h3 style="color: #228B22; margin-bottom: 10px;">👥 Active Users</h3>
            <p style="font-size: 1.5rem; font-weight: bold; color: #228B22;">{{ active_users_week }}</p>
            <p style="color: #666; font-size: 14px;">Active this week</p>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #d4af37;">
            <h3 style="color: #d4af37; margin-bottom: 10px;">📊 Avg. Risk Score</h3>
            <p style="font-size: 1.5rem; font-weight: bold; color: #d4af37;">{{ "%.1f"|format(avg_risk_score) }}%</p>
            <p style="color: #666; font-size: 14px;">System average</p>
        </div>
    </div>
</div>

<script>
function markFollowedUp(assessmentId) {
    if (confirm('Mark this high-risk case as followed up?')) {
        fetch(`/admin/mark_followed_up/${assessmentId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the follow-up status.');
        });
    }
}
</script>

<style>
.grid-4 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
</style>
{% endblock %}
