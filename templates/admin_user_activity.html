{% extends "base.html" %}

{% block title %}User Activity - Admin Panel{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="color: #d4af37; margin-bottom: 10px;">üìà User Activity Monitoring</h1>
            <p style="color: #1e3a5f; font-size: 1.1rem;">Track user engagement and system usage patterns</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                ‚Üê Back to Dashboard
            </a>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-secondary">
                üö™ Logout
            </a>
        </div>
    </div>
</div>

<div class="card">
    <h2>üìä Activity Overview</h2>
    {% if user_activity %}
        {% set active_users = user_activity|selectattr('3')|list|length %}
        {% set total_assessments = user_activity|map(attribute='4')|sum %}
        {% set avg_assessments = (total_assessments / user_activity|length)|round(1) if user_activity|length > 0 else 0 %}
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                <div style="font-size: 2rem; font-weight: bold; color: #28a745;">{{ user_activity|length }}</div>
                <div style="color: #28a745; font-weight: bold;">Total Users</div>
            </div>
            
            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                <div style="font-size: 2rem; font-weight: bold; color: #007bff;">{{ active_users }}</div>
                <div style="color: #007bff; font-weight: bold;">Users with Login History</div>
            </div>
            
            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
                <div style="font-size: 2rem; font-weight: bold; color: #ffc107;">{{ total_assessments }}</div>
                <div style="color: #ffc107; font-weight: bold;">Total Assessments</div>
            </div>
            
            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6f42c1;">
                <div style="font-size: 2rem; font-weight: bold; color: #6f42c1;">{{ avg_assessments }}</div>
                <div style="color: #6f42c1; font-weight: bold;">Avg. Assessments/User</div>
            </div>
        </div>
    {% endif %}
</div>

<div class="card">
    <h2>üë• User Activity Details</h2>
    {% if user_activity %}
        <div style="margin-bottom: 20px;">
            <input type="text" id="searchInput" placeholder="üîç Search by username or full name..." 
                   style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;"
                   onkeyup="filterUsers()">
        </div>
        
        <div style="overflow-x: auto;">
            <table id="activityTable" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">User Info</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Last Login</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Assessments</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Last Assessment</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Activity Status</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in user_activity %}
                        <tr style="border-bottom: 1px solid #dee2e6;" class="activity-row">
                            <td style="padding: 12px;" class="user-info">
                                <div style="font-weight: bold; color: #1e3a5f;" class="full-name">{{ activity[2] }}</div>
                                <div style="color: #666; font-size: 14px;" class="username">@{{ activity[1] }}</div>
                                <div style="color: #999; font-size: 12px;">ID: {{ activity[0] }}</div>
                            </td>
                            <td style="padding: 12px;">
                                {% if activity[3] %}
                                    <div style="color: #28a745; font-weight: bold;">{{ activity[3][:10] }}</div>
                                    <div style="color: #666; font-size: 12px;">{{ activity[3][11:16] if activity[3] and len(activity[3]) > 11 else '' }}</div>
                                {% else %}
                                    <span style="color: #dc3545; font-weight: bold;">Never logged in</span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">
                                <div style="text-align: center;">
                                    <span style="background: {% if activity[4] == 0 %}#dc3545{% elif activity[4] < 3 %}#ffc107{% else %}#28a745{% endif %}; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold;">
                                        {{ activity[4] }}
                                    </span>
                                </div>
                            </td>
                            <td style="padding: 12px;">
                                {% if activity[5] %}
                                    <div style="color: #007bff;">{{ activity[5][:10] }}</div>
                                    <div style="color: #666; font-size: 12px;">{{ activity[5][11:16] if activity[5] and len(activity[5]) > 11 else '' }}</div>
                                {% else %}
                                    <span style="color: #999;">No assessments</span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">
                                {% set days_since_login = 999 %}
                                {% if activity[3] %}
                                    {% set days_since_login = 0 %}  {# Simplified for template #}
                                {% endif %}
                                
                                {% if not activity[3] %}
                                    <span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                        üî¥ Never Active
                                    </span>
                                {% elif activity[4] == 0 %}
                                    <span style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                        üü° Registered Only
                                    </span>
                                {% elif activity[4] < 3 %}
                                    <span style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                        üîµ Low Activity
                                    </span>
                                {% else %}
                                    <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                        üü¢ Active User
                                    </span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    {% if not activity[3] %}
                                        <button onclick="sendActivationReminder({{ activity[0] }}, '{{ activity[2] }}')" 
                                                class="btn" 
                                                style="background: #ffc107; color: #000; padding: 6px 12px; font-size: 12px;">
                                            üìß Send Reminder
                                        </button>
                                    {% endif %}
                                    <button onclick="viewUserDetails({{ activity[0] }})" 
                                            class="btn btn-secondary" 
                                            style="padding: 6px 12px; font-size: 12px;">
                                        üëÅÔ∏è View Details
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 20px; text-align: center; color: #666;">
            <p>Total Users: <span id="totalCount">{{ user_activity|length }}</span></p>
        </div>
    {% else %}
        <p style="color: #666; text-align: center; padding: 40px;">No user activity data available</p>
    {% endif %}
</div>

<script>
function filterUsers() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('activityTable');
    const rows = table.getElementsByClassName('activity-row');
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const fullName = rows[i].getElementsByClassName('full-name')[0].textContent.toLowerCase();
        const username = rows[i].getElementsByClassName('username')[0].textContent.toLowerCase();
        
        if (fullName.includes(filter) || username.includes(filter)) {
            rows[i].style.display = '';
            visibleCount++;
        } else {
            rows[i].style.display = 'none';
        }
    }
    
    document.getElementById('totalCount').textContent = visibleCount;
}

function sendActivationReminder(userId, userName) {
    if (confirm(`Send activation reminder to ${userName}?`)) {
        // In a real implementation, this would send an email reminder
        alert(`Activation reminder would be sent to ${userName}\n\nThis would typically:\n- Send email reminder about completing their first assessment\n- Include system benefits and features\n- Provide direct link to assessment page`);
    }
}

function viewUserDetails(userId) {
    // In a real implementation, this would show detailed user information
    alert(`This would show detailed information for User ID: ${userId}\n\nWould include:\n- Complete profile information\n- Assessment history\n- Login patterns\n- System usage statistics`);
}
</script>
{% endblock %}
