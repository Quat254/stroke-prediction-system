{% extends "base.html" %}

{% block title %}Login Audit Trail - Admin Panel{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="color: #d4af37; margin-bottom: 10px;">üîç Login Audit Trail</h1>
            <p style="color: #1e3a5f; font-size: 1.1rem;">Monitor user authentication and security events</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                ‚Üê Back to Dashboard
            </a>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-secondary">
                üö™ Logout
            </a>
        </div>
    </div>
</div>

<div class="card">
    <h2>üîí Security Overview</h2>
    {% if login_logs %}
        {% set users_with_login = login_logs|selectattr('3')|list|length %}
        {% set never_logged_in = login_logs|rejectattr('3')|list|length %}
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="text-align: center; padding: 20px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                <div style="font-size: 2rem; font-weight: bold; color: #155724;">{{ users_with_login }}</div>
                <div style="color: #155724; font-weight: bold;">‚úÖ Users with Login History</div>
            </div>
            
            <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <div style="font-size: 2rem; font-weight: bold; color: #856404;">{{ never_logged_in }}</div>
                <div style="color: #856404; font-weight: bold;">‚ö†Ô∏è Never Logged In</div>
            </div>
            
            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6c757d;">
                <div style="font-size: 2rem; font-weight: bold; color: #495057;">0</div>
                <div style="color: #495057; font-weight: bold;">üö´ Failed Login Attempts</div>
                <div style="font-size: 12px; color: #6c757d;">(Last 24h)</div>
            </div>
            
            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                <div style="font-size: 2rem; font-weight: bold; color: #117a8b;">{{ login_logs|length }}</div>
                <div style="color: #117a8b; font-weight: bold;">üë• Total User Accounts</div>
            </div>
        </div>
    {% endif %}
</div>

<div class="card">
    <h2>üìã Login History & User Authentication</h2>
    {% if login_logs %}
        <div style="margin-bottom: 20px;">
            <input type="text" id="searchInput" placeholder="üîç Search by username or full name..." 
                   style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;"
                   onkeyup="filterLogs()">
        </div>
        
        <div style="overflow-x: auto;">
            <table id="logsTable" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">User Information</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Account Created</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Last Login</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Activity Level</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Security Status</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in login_logs %}
                        <tr style="border-bottom: 1px solid #dee2e6;" class="log-row">
                            <td style="padding: 12px;" class="user-info">
                                <div style="font-weight: bold; color: #1e3a5f;" class="full-name">{{ log[2] }}</div>
                                <div style="color: #666; font-size: 14px;" class="username">@{{ log[1] }}</div>
                                <div style="color: #999; font-size: 12px;">ID: {{ log[0] }}</div>
                            </td>
                            <td style="padding: 12px;">
                                <div style="color: #007bff;">{{ log[4][:10] if log[4] else 'N/A' }}</div>
                                <div style="color: #666; font-size: 12px;">{{ log[4][11:16] if log[4] and len(log[4]) > 11 else '' }}</div>
                            </td>
                            <td style="padding: 12px;">
                                {% if log[3] %}
                                    <div style="color: #28a745; font-weight: bold;">{{ log[3][:10] }}</div>
                                    <div style="color: #666; font-size: 12px;">{{ log[3][11:16] if log[3] and len(log[3]) > 11 else '' }}</div>
                                    <div style="color: #999; font-size: 11px; margin-top: 2px;">
                                        {# Calculate days ago - simplified for template #}
                                        Recent activity
                                    </div>
                                {% else %}
                                    <span style="color: #dc3545; font-weight: bold;">Never</span>
                                    <div style="color: #dc3545; font-size: 12px;">No login recorded</div>
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">
                                <div style="text-align: center;">
                                    <span style="background: {% if log[5] == 0 %}#dc3545{% elif log[5] < 3 %}#ffc107{% else %}#28a745{% endif %}; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 14px;">
                                        {{ log[5] }}
                                    </span>
                                    <div style="color: #666; font-size: 12px; margin-top: 4px;">
                                        {% if log[5] == 0 %}No assessments
                                        {% elif log[5] == 1 %}1 assessment
                                        {% else %}{{ log[5] }} assessments{% endif %}
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 12px;">
                                {% if not log[3] %}
                                    <span style="background: #ffc107; color: #000; padding: 6px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                        ‚ö†Ô∏è Inactive Account
                                    </span>
                                {% elif log[5] == 0 %}
                                    <span style="background: #17a2b8; color: white; padding: 6px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                        üîµ Registered Only
                                    </span>
                                {% else %}
                                    <span style="background: #28a745; color: white; padding: 6px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                        ‚úÖ Active User
                                    </span>
                                {% endif %}
                                <div style="margin-top: 4px;">
                                    <span style="background: #f8f9fa; color: #495057; padding: 2px 6px; border-radius: 8px; font-size: 11px;">
                                        üîí No security issues
                                    </span>
                                </div>
                            </td>
                            <td style="padding: 12px;">
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    {% if not log[3] %}
                                        <button onclick="sendLoginReminder({{ log[0] }}, '{{ log[2] }}')" 
                                                class="btn" 
                                                style="background: #ffc107; color: #000; padding: 6px 12px; font-size: 12px;">
                                            üìß Send Login Reminder
                                        </button>
                                    {% endif %}
                                    <button onclick="resetPassword({{ log[0] }}, '{{ log[1] }}')" 
                                            class="btn btn-secondary" 
                                            style="padding: 6px 12px; font-size: 12px;">
                                        üîë Reset Password
                                    </button>
                                    <button onclick="viewLoginHistory({{ log[0] }})" 
                                            class="btn btn-secondary" 
                                            style="padding: 6px 12px; font-size: 12px;">
                                        üìä View History
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 20px; text-align: center; color: #666;">
            <p>Total User Accounts: <span id="totalCount">{{ login_logs|length }}</span></p>
        </div>
    {% else %}
        <p style="color: #666; text-align: center; padding: 40px;">No login data available</p>
    {% endif %}
</div>

<div class="card">
    <h2>üõ°Ô∏è Security Recommendations</h2>
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8;">
        <h4 style="color: #117a8b; margin-bottom: 15px;">Current Security Status: Good ‚úÖ</h4>
        <ul style="color: #495057; margin: 0; padding-left: 20px;">
            <li style="margin-bottom: 8px;">No failed login attempts detected in the last 24 hours</li>
            <li style="margin-bottom: 8px;">All user accounts are using secure password hashing</li>
            <li style="margin-bottom: 8px;">Session management is properly configured</li>
            <li style="margin-bottom: 8px;">Consider implementing two-factor authentication for enhanced security</li>
        </ul>
    </div>
</div>

<script>
function filterLogs() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('logsTable');
    const rows = table.getElementsByClassName('log-row');
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const fullName = rows[i].getElementsByClassName('full-name')[0].textContent.toLowerCase();
        const username = rows[i].getElementsByClassName('username')[0].textContent.toLowerCase();
        
        if (fullName.includes(filter) || username.includes(filter)) {
            rows[i].style.display = '';
            visibleCount++;
        } else {
            rows[i].style.display = 'none';
        }
    }
    
    document.getElementById('totalCount').textContent = visibleCount;
}

function sendLoginReminder(userId, userName) {
    if (confirm(`Send login reminder to ${userName}?`)) {
        alert(`Login reminder would be sent to ${userName}\n\nThis would typically:\n- Send email with login instructions\n- Include system benefits and features\n- Provide direct login link\n- Include password reset option if needed`);
    }
}

function resetPassword(userId, username) {
    if (confirm(`Reset password for user "${username}"?`)) {
        alert(`Password reset would be initiated for ${username}\n\nThis would typically:\n- Generate secure temporary password\n- Send reset instructions via email\n- Log the password reset event\n- Require user to change password on next login`);
    }
}

function viewLoginHistory(userId) {
    alert(`This would show detailed login history for User ID: ${userId}\n\nWould include:\n- All login timestamps\n- IP addresses (if tracked)\n- Browser/device information\n- Failed login attempts\n- Session durations`);
}
</script>
{% endblock %}
